@model PCOMS.Application.DTOs.ResourceAnalyticsDto

@{
    ViewData["Title"] = "Resource Management Dashboard";
}

<div class="container-fluid mt-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-md-8">
            <h2><i class="bi bi-people"></i> Resource Management</h2>
            <p class="text-muted">Team capacity, allocation & utilization tracking</p>
        </div>
        <div class="col-md-4 text-end">
            <a asp-action="TeamMembers" class="btn btn-primary">
                <i class="bi bi-person-plus"></i> Manage Team
            </a>
            <a asp-action="ResourceRequests" class="btn btn-outline-secondary">
                <i class="bi bi-inbox"></i> Requests (@Model.PendingRequests)
            </a>
        </div>
    </div>

    <!-- KEY METRICS -->
    <div class="row g-3 mb-4">
        <div class="col-md-3">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-muted mb-1">Team Members</h6>
                            <h2 class="mb-0">@Model.ActiveMembers<small class="text-muted fs-6">/@Model.TotalTeamMembers</small></h2>
                            <small class="text-success">Active</small>
                        </div>
                        <div class="text-primary fs-1">
                            <i class="bi bi-people-fill"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-muted mb-1">Avg Utilization</h6>
                            <h2 class="mb-0 @(Model.AverageUtilization >= 70 && Model.AverageUtilization <= 85 ? "text-success" : Model.AverageUtilization > 100 ? "text-danger" : "text-warning")">
                                @Model.AverageUtilization.ToString("N0")%
                            </h2>
                            <small class="text-muted">Target: 70-85%</small>
                        </div>
                        <div class="text-info fs-1">
                            <i class="bi bi-speedometer2"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-muted mb-1">Overallocated</h6>
                            <h2 class="mb-0 text-danger">@Model.OverallocatedCount</h2>
                            <small class="text-muted">⚠️ Need attention</small>
                        </div>
                        <div class="text-danger fs-1">
                            <i class="bi bi-exclamation-triangle-fill"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-muted mb-1">Underutilized</h6>
                            <h2 class="mb-0 text-warning">@Model.UnderutilizedCount</h2>
                            <small class="text-muted">Available capacity</small>
                        </div>
                        <div class="text-warning fs-1">
                            <i class="bi bi-battery-half"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- UTILIZATION BREAKDOWN -->
    <div class="row mb-4">
        <div class="col-lg-8">
            <div class="card shadow-sm">
                <div class="card-header d-flex justify-content-between">
                    <h6 class="mb-0"><i class="bi bi-bar-chart"></i> Team Utilization Breakdown</h6>
                    <a asp-action="UtilizationReport" class="btn btn-sm btn-outline-primary">View Full Report</a>
                </div>
                <div class="card-body">
                    @if (Model.UtilizationBreakdown.Any())
                    {
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Member</th>
                                        <th>Role</th>
                                        <th>Capacity</th>
                                        <th>Allocated</th>
                                        <th>Utilization</th>
                                        <th>Projects</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var member in Model.UtilizationBreakdown.Take(10))
                                    {
                                        var statusColor = member.Status switch
                                        {
                                            "Overallocated" => "danger",
                                            "Optimal" => "success",
                                            _ => "warning"
                                        };

                                        <tr>
                                            <td>
                                                <a asp-action="TeamMemberDetails" asp-route-id="@member.TeamMemberId">
                                                    @member.TeamMemberName
                                                </a>
                                            </td>
                                            <td>@member.JobTitle</td>
                                            <td>@member.WeeklyCapacityHours h/wk</td>
                                            <td>@member.AllocatedHours.ToString("N1") h</td>
                                            <td>
                                                <div class="d-flex align-items-center">
                                                    <div class="progress flex-grow-1 me-2" style="height:8px;width:80px">
                                                        <div class="progress-bar bg-@statusColor" style="width:@(Math.Min(member.UtilizationPercentage, 100))%"></div>
                                                    </div>
                                                    <strong class="text-@statusColor">@member.UtilizationPercentage.ToString("N0")%</strong>
                                                </div>
                                            </td>
                                            <td>@member.ActiveProjectsCount</td>
                                            <td><span class="badge bg-@statusColor-subtle text-@statusColor">@member.Status</span></td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                    else
                    {
                        <p class="text-center text-muted py-4">No team members yet</p>
                    }
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <!-- Top Skills -->
            <div class="card shadow-sm mb-3">
                <div class="card-header">
                    <h6 class="mb-0"><i class="bi bi-star"></i> Top Skills</h6>
                </div>
                <div class="card-body">
                    @if (Model.TopSkills.Any())
                    {
                        @foreach (var skill in Model.TopSkills.Take(8))
                        {
                            var percentage = Model.ActiveMembers > 0 ? (decimal)skill.Value / Model.ActiveMembers * 100 : 0;
                            <div class="mb-2">
                                <div class="d-flex justify-content-between mb-1">
                                    <span class="small">@skill.Key</span>
                                    <span class="small fw-bold">@skill.Value</span>
                                </div>
                                <div class="progress" style="height:6px">
                                    <div class="progress-bar bg-primary" style="width:@percentage%"></div>
                                </div>
                            </div>
                        }
                        <a asp-action="SkillsMatrix" class="btn btn-sm btn-outline-secondary w-100 mt-2">
                            View Skills Matrix
                        </a>
                    }
                    else
                    {
                        <p class="text-muted text-center small">No skills tracked yet</p>
                    }
                </div>
            </div>

            <!-- By Department -->
            <div class="card shadow-sm">
                <div class="card-header">
                    <h6 class="mb-0"><i class="bi bi-diagram-3"></i> By Department</h6>
                </div>
                <div class="card-body">
                    @if (Model.MembersByDepartment.Any())
                    {
                        <canvas id="departmentChart" width="300" height="200"></canvas>
                    }
                    else
                    {
                        <p class="text-muted text-center small">No departments yet</p>
                    }
                </div>
            </div>
        </div>
    </div>

    <!-- QUICK ACTIONS -->
    <div class="row">
        <div class="col-md-3">
            <div class="card shadow-sm border-primary">
                <div class="card-body text-center py-4">
                    <i class="bi bi-person-plus fs-1 text-primary mb-3"></i>
                    <h6>Add Team Member</h6>
                    <a asp-action="CreateTeamMember" class="btn btn-primary btn-sm">Add Now</a>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card shadow-sm border-success">
                <div class="card-body text-center py-4">
                    <i class="bi bi-arrow-left-right fs-1 text-success mb-3"></i>
                    <h6>Allocate Resources</h6>
                    <a asp-action="CreateAllocation" class="btn btn-success btn-sm">Allocate</a>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card shadow-sm border-warning">
                <div class="card-body text-center py-4">
                    <i class="bi bi-inbox fs-1 text-warning mb-3"></i>
                    <h6>Resource Requests</h6>
                    <a asp-action="ResourceRequests" class="btn btn-warning btn-sm">
                        View (@Model.PendingRequests)
                    </a>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card shadow-sm border-info">
                <div class="card-body text-center py-4">
                    <i class="bi bi-grid-3x3 fs-1 text-info mb-3"></i>
                    <h6>Skills Matrix</h6>
                    <a asp-action="SkillsMatrix" class="btn btn-info btn-sm">View Matrix</a>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        const deptData = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.MembersByDepartment));

        if (Object.keys(deptData).length > 0) {
            new Chart(document.getElementById('departmentChart'), {
                type: 'doughnut',
                data: {
                    labels: Object.keys(deptData),
                    datasets: [{
                        data: Object.values(deptData),
                        backgroundColor: ['#0d6efd', '#6c757d', '#198754', '#ffc107', '#dc3545']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom' }
                    }
                }
            });
        }
    </script>
}
