@model PCOMS.Application.DTOs.EditProjectDto
@using PCOMS.Models

<h2>Edit Project</h2>
<hr />

@if (!string.IsNullOrEmpty(Model.ManagerName))
{
    <p class="text-muted">
        Project Manager:
        <strong>@Model.ManagerName</strong>
    </p>
}

@if (TempData["Success"] != null)
{
    <div class="alert alert-success">@TempData["Success"]</div>
}

@if (TempData["Error"] != null)
{
    <div class="alert alert-danger">@TempData["Error"]</div>
}

<div class="row">
    <!-- ========================= -->
    <!-- PROJECT DETAILS -->
    <!-- ========================= -->
    <div class="col-md-6">
        <form asp-action="Edit" method="post">
            @Html.AntiForgeryToken()

            <!-- REQUIRED -->
            <input type="hidden" asp-for="Id" />
            <input type="hidden" asp-for="ClientId" />
            <input type="hidden" asp-for="ManagerId" />
            <input type="hidden" asp-for="Name" />
            <input type="hidden" asp-for="Description" />

            <!-- STATUS -->
            <div class="mb-3">
                <label asp-for="Status" class="form-label"></label>
                <select asp-for="Status"
                        class="form-select"
                        asp-items="Html.GetEnumSelectList<ProjectStatus>()">
                </select>
            </div>

            <!-- HOURLY RATE -->
            @if (Model.Status == ProjectStatus.Completed ||
                        Model.Status == ProjectStatus.Archived)
            {
                <div class="mb-3">
                    <label class="form-label">Hourly Rate</label>
                    <input class="form-control"
                           value="@Model.HourlyRate"
                           disabled />
                    <!-- hidden so value still posts -->
                    <input type="hidden" asp-for="HourlyRate" />
                </div>
            }
            else
            {
                <div class="mb-3">
                    <label asp-for="HourlyRate" class="form-label"></label>
                    <input asp-for="HourlyRate"
                           type="number"
                           step="0.01"
                           class="form-control" />
                    <span asp-validation-for="HourlyRate"
                          class="text-danger"></span>
                </div>
            }

            <button type="submit" class="btn btn-success">
                Save Changes
            </button>

            <a asp-action="Client"
               asp-route-id="@Model.ClientId"
               class="btn btn-secondary ms-2">
                Cancel
            </a>
        </form>
    </div>

    <!-- ========================= -->
    <!-- ASSIGN DEVELOPERS -->
    <!-- ========================= -->
    @if (User.IsInRole("ProjectManager") &&
        Model.Status == ProjectStatus.Active)
    {
        <div class="col-md-6">
            <h4>Assign Developers</h4>

            <form asp-controller="ProjectAssignments"
                  asp-action="Assign"
                  method="post">
                @Html.AntiForgeryToken()

                <input type="hidden"
                       name="projectId"
                       value="@Model.Id" />

                <div class="mb-3">
                    <label class="form-label">Developer</label>
                    <select name="developerId"
                            class="form-select"
                            required>
                        <option value="">-- Select Developer --</option>

                        @foreach (var dev in ViewBag.Developers)
                        {
                            <option value="@dev.Id">
                                @dev.Email
                            </option>
                        }
                    </select>
                </div>

                <button type="submit"
                        class="btn btn-primary">
                    Assign Developer
                </button>
            </form>

            <hr />
            <h5>Assigned Developers</h5>

            @if (ViewBag.AssignedDevelopers != null &&
                    ViewBag.AssignedDevelopers.Count > 0)
            {
                <ul class="list-group">
                    @foreach (var a in ViewBag.AssignedDevelopers)
                    {
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            @a.Developer.Email

                            <form asp-controller="ProjectAssignments"
                                  asp-action="Remove"
                                  method="post">
                                @Html.AntiForgeryToken()
                                <input type="hidden" name="projectId" value="@a.ProjectId" />
                                <input type="hidden" name="developerId" value="@a.DeveloperId" />
                                <button class="btn btn-sm btn-danger">
                                    Remove
                                </button>
                            </form>
                        </li>
                    }
                </ul>
            }
            else
            {
                <p class="text-muted">
                    No developers assigned yet.
                </p>
            }
        </div>
    }
</div>
